// netlify/functions/cashfree-verify-payment.js

exports.handler = async (event, context) => {
  // Only allow POST requests
  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      body: JSON.stringify({ error: 'Method not allowed' })
    };
  }

  try {
    const data = JSON.parse(event.body);
    const orderId = data.order_id;
    
    if (!orderId) {
      return {
        statusCode: 400,
        body: JSON.stringify({
          success: false,
          message: 'Order ID is required'
        })
      };
    }
    
    // Cashfree credentials from environment variables
    const appId = process.env.CASHFREE_APP_ID;
    const secretKey = process.env.CASHFREE_SECRET_KEY;
    const environment = process.env.CASHFREE_ENV || 'TEST';
    
    // Determine API endpoint based on environment
    const apiUrl = environment === 'PROD' 
      ? `https://api.cashfree.com/pg/orders/${orderId}`
      : `https://sandbox.cashfree.com/pg/orders/${orderId}`;
    
    console.log('Verifying payment for order:', orderId);
    console.log('Environment:', environment);
    console.log('API URL:', apiUrl);
    
    // Call Cashfree API to get order status
    const response = await fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'x-client-id': appId,
        'x-client-secret': secretKey,
        'x-api-version': '2023-08-01'
      }
    });
    
    const orderData = await response.json();
    
    // ✅ FIXED: Log both order_status and payment_status
    console.log('Order Status:', orderData.order_status);
    console.log('Payment Status:', orderData.payment_status);
    console.log('Full Order Data:', JSON.stringify(orderData, null, 2));
    
    if (orderData.order_status) {
      // ✅ FIXED: Return BOTH order_status and payment_status
      // This allows payment-verify.html to check either field
      return {
        statusCode: 200,
        body: JSON.stringify({
          success: true,
          order_id: orderId,
          order_status: orderData.order_status,        // ✅ ADDED: Return order_status
          payment_status: orderData.payment_status,    // ✅ ADDED: Return payment_status
          order_amount: orderData.order_amount,
          order_currency: orderData.order_currency,
          customer_details: orderData.customer_details
        })
      };
    } else {
      console.error('Failed to get order status:', orderData);
      
      return {
        statusCode: 400,
        body: JSON.stringify({
          success: false,
          message: 'Failed to verify payment status',
          error: orderData
        })
      };
    }
    
  } catch (error) {
    console.error('Error verifying payment:', error);
    
    return {
      statusCode: 500,
      body: JSON.stringify({
        success: false,
        message: 'Internal server error',
        error: error.message
      })
    };
  }
};
